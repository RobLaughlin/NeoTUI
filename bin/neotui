#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="${BASH_SOURCE[0]}"

while [ -L "$SCRIPT_PATH" ]; do
  LINK_TARGET="$(readlink "$SCRIPT_PATH")"
  if [[ "$LINK_TARGET" == /* ]]; then
    SCRIPT_PATH="$LINK_TARGET"
  else
    SCRIPT_PATH="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)/$LINK_TARGET"
  fi
done

SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

export NEOTUI_HOME="$ROOT_DIR"
export NEOTUI_ROOT="$ROOT_DIR"
export XDG_CONFIG_HOME="$ROOT_DIR/config"
export XDG_DATA_HOME="$ROOT_DIR/data"
export XDG_STATE_HOME="$ROOT_DIR/state"
export XDG_CACHE_HOME="$ROOT_DIR/cache"
export NEOTUI_CONFIG_HOME="$XDG_CONFIG_HOME"
export GH_CONFIG_DIR="$XDG_CONFIG_HOME/gh"
export PATH="$ROOT_DIR/bin:$PATH"
export ZDOTDIR="$XDG_CONFIG_HOME/shell"
export HISTFILE="$XDG_STATE_HOME/zsh/history"
export EDITOR="nvim"
export VISUAL="nvim"
shell_path="$(command -v zsh)"
export SHELL="$shell_path"

mkdir -p "$XDG_CONFIG_HOME" "$XDG_DATA_HOME" "$XDG_STATE_HOME" "$XDG_CACHE_HOME" "$(dirname "$HISTFILE")"

usage() {
  printf 'Usage: neotui [--debug] [tmux|zsh|nvim|lf] [args...]\n'
  printf '\n'
  printf 'Subcommands:\n'
  printf '  tmux         Start NeoTUI tmux session (default)\n'
  printf '  zsh          Start NeoTUI zsh\n'
  printf '  nvim [args] Start NeoTUI neovim\n'
  printf '  lf           Start NeoTUI lf\n'
  printf '\n'
  printf 'Installed tmux defaults:\n'
  printf '  - top status bar with tab navigation\n'
  printf '  - pane navigation: <prefix> h/j/k/l\n'
  printf '  - pane split: <prefix>+| and <prefix>+-\n'
  printf '  - pane resize: <prefix>+H/J/K/L\n'
  printf '  - lf toggle: <prefix>+E (open/close left sidebar)\n'
  printf '\n'
  printf 'Installed lf defaults:\n'
  printf '  - opens by default as left sidebar on new neotui session\n'
  printf '  - auto-refreshes on file create/delete changes (watch + 2s poll fallback)\n'
  printf '  - file preview is off by default\n'
  printf '  - gh: jump to home directory\n'
  printf '  - gz: toggle file preview (off <-> 2:3 preview)\n'
  printf '  - gs: sync lf directory to zsh pane path (same window)\n'
  printf '  - l: enter dir, or open file in nvim (reuse nvim pane via tab, else split)\n'
  printf '  - Enter: enter dir, or open file in nvim new tmux window\n'
  printf '  - nvim tabs: gt/gT (next/prev), :tabn/:tabp, :tabclose\n'
  printf '  - yy/yY: toggle queue current item for copy/cut\n'
  printf '  - queued marker: y (copy), Y (cut)\n'
  printf '  - p/P: execute queued copy/cut items (copy queue keeps, cut queue clears)\n'
  printf '  - yq: show queue status, c: clear all queues\n'
  printf '  - md: create directory, mf: create file\n'
  printf '  - dd: move to NeoTUI trash (confirmed)\n'
  printf '  - gu/gr: undo/redo last create/paste/delete action\n'
  printf '  - delete recovery is session-scoped (cleared when session ends)\n'
  printf '\n'
  printf 'Installed nvim defaults:\n'
  printf '  - Ctrl+h: previous nvim tab\n'
  printf '  - Ctrl+l: next nvim tab\n'
  printf '\n'
  printf 'Installed zsh defaults:\n'
  printf '  - lfsync: sync zsh cwd to lf pane path (same window)\n'
}

print_tool_info() {
  local name="$1"
  local version_cmd="$2"

  if ! command -v "$name" >/dev/null 2>&1; then
    printf '  - %-4s: missing\n' "$name"
    return
  fi

  local path
  local version
  path="$(command -v "$name")"
  version="$(eval "$version_cmd" 2>/dev/null | awk 'NR==1 {print; exit}')"
  if [ -z "$version" ]; then
    version="unknown"
  fi
  printf '  - %-4s: %s (%s)\n' "$name" "$path" "$version"
}

print_link_status() {
  local label="$1"
  local path="$2"
  local expected="$3"

  if [ ! -e "$path" ] && [ ! -L "$path" ]; then
    printf '  - %-5s: absent (%s)\n' "$label" "$path"
    return
  fi

  if [ -L "$path" ]; then
    local target
    target="$(readlink "$path")"
    if [ "$target" = "$expected" ]; then
      printf '  - %-5s: linked to NeoTUI (%s -> %s)\n' "$label" "$path" "$target"
    else
      printf '  - %-5s: symlink not NeoTUI (%s -> %s)\n' "$label" "$path" "$target"
    fi
    return
  fi

  printf '  - %-5s: regular file exists (%s)\n' "$label" "$path"
}

debug_report() {
  printf 'NeoTUI debug report\n'
  printf 'root: %s\n' "$ROOT_DIR"
  printf 'command: %s\n' "$command_name"
  printf 'tools:\n'
  print_tool_info tmux "tmux -V"
  print_tool_info zsh "zsh --version"
  print_tool_info nvim "nvim --version"
  print_tool_info lf "lf -version"
  printf 'global-config links:\n'
  print_link_status tmux "$HOME/.tmux.conf" "$XDG_CONFIG_HOME/tmux/tmux.conf"
  print_link_status zsh "$HOME/.zshrc" "$XDG_CONFIG_HOME/shell/.zshrc"
  print_link_status nvim "$HOME/.config/nvim/init.lua" "$XDG_CONFIG_HOME/nvim/init.lua"
  printf 'env:\n'
  printf '  - NEOTUI_ROOT: %s\n' "$NEOTUI_ROOT"
  printf '  - XDG_CONFIG_HOME: %s\n' "$XDG_CONFIG_HOME"
  printf '  - XDG_DATA_HOME: %s\n' "$XDG_DATA_HOME"
  printf '  - XDG_STATE_HOME: %s\n' "$XDG_STATE_HOME"
  printf '  - XDG_CACHE_HOME: %s\n' "$XDG_CACHE_HOME"
  printf '  - ZDOTDIR: %s\n' "$ZDOTDIR"
  printf '  - GH_CONFIG_DIR: %s\n' "$GH_CONFIG_DIR"
}

debug_mode=0
while [ "$#" -gt 0 ]; do
  case "$1" in
    --debug)
      debug_mode=1
      shift
      ;;
    --)
      shift
      break
      ;;
    -h|--help|help)
      command_name="help"
      shift
      break
      ;;
    -* )
      usage >&2
      exit 1
      ;;
    *)
      break
      ;;
  esac
done

if [ "${command_name:-}" != "help" ]; then
  command_name="${1:-tmux}"
  if [ "$#" -gt 0 ]; then
    shift
  fi
fi

if [ "$debug_mode" -eq 1 ]; then
  debug_report
  exit 0
fi

case "$command_name" in
  tmux)
    if tmux -L neotui has-session -t neotui 2>/dev/null; then
      session_id="$(tmux -L neotui display-message -p -t neotui '#{session_id}')"
      session_id="$(printf '%s' "$session_id" | tr -cd 'A-Za-z0-9_-')"
      tmux -L neotui -f "$XDG_CONFIG_HOME/tmux/tmux.conf" attach-session -t neotui
      if ! tmux -L neotui has-session -t neotui 2>/dev/null; then
        "$ROOT_DIR/bin/neotui-clean-session" "$session_id"
      fi
      exit 0
    fi

    rm -rf -- "$XDG_STATE_HOME/lf/sessions"
    mkdir -p "$XDG_STATE_HOME/lf/sessions"
    rm -f -- "$XDG_DATA_HOME/lf/tags"

    tmux -L neotui -f "$XDG_CONFIG_HOME/tmux/tmux.conf" new-session -d -s neotui -c "$PWD"
    tmux -L neotui set-environment -t neotui NEOTUI_ROOT "$ROOT_DIR"
    tmux -L neotui set-environment -t neotui NEOTUI_CONFIG_HOME "$XDG_CONFIG_HOME"
    session_id="$(tmux -L neotui display-message -p -t neotui '#{session_id}')"
    session_id="$(printf '%s' "$session_id" | tr -cd 'A-Za-z0-9_-')"
    tmux -L neotui set-environment -t neotui NEOTUI_SESSION_ID "$session_id"
    "$ROOT_DIR/bin/neotui-watch-session" "neotui" "$session_id" >/dev/null 2>&1 &
    tmux -L neotui split-window -t neotui:0 -hb -l 32 -c "$PWD" "lf -config '$XDG_CONFIG_HOME/lf/lfrc'"
    tmux -L neotui select-pane -t neotui:0 -R
    tmux -L neotui -f "$XDG_CONFIG_HOME/tmux/tmux.conf" attach-session -t neotui
    if ! tmux -L neotui has-session -t neotui 2>/dev/null; then
      "$ROOT_DIR/bin/neotui-clean-session" "$session_id"
    fi
    exit 0
    ;;
  zsh)
    exec zsh "$@"
    ;;
  nvim)
    exec nvim -u "$XDG_CONFIG_HOME/nvim/init.lua" "$@"
    ;;
  lf)
    exec lf -config "$XDG_CONFIG_HOME/lf/lfrc" "$@"
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    usage >&2
    exit 1
    ;;
esac
