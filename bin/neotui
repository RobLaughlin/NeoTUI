#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="${BASH_SOURCE[0]}"

while [ -L "$SCRIPT_PATH" ]; do
  LINK_TARGET="$(readlink "$SCRIPT_PATH")"
  if [[ "$LINK_TARGET" == /* ]]; then
    SCRIPT_PATH="$LINK_TARGET"
  else
    SCRIPT_PATH="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)/$LINK_TARGET"
  fi
done

SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

export NEOTUI_ROOT="$ROOT_DIR"
export XDG_CONFIG_HOME="$ROOT_DIR"
export XDG_DATA_HOME="$ROOT_DIR/.local/data"
export XDG_STATE_HOME="$ROOT_DIR/.local/state"
export XDG_CACHE_HOME="$ROOT_DIR/.local/cache"
export PATH="$ROOT_DIR/.local/bin:$PATH"
export ZDOTDIR="$ROOT_DIR/shell"
export HISTFILE="$XDG_STATE_HOME/zsh/history"
export EDITOR="nvim"
export VISUAL="nvim"
export NVIM_APPNAME="nvim"

mkdir -p "$XDG_DATA_HOME" "$XDG_STATE_HOME" "$XDG_CACHE_HOME" "$(dirname "$HISTFILE")"

usage() {
  printf 'Usage: neotui [tmux|zsh|nvim|lf] [args...]\n'
}

command_name="${1:-tmux}"
if [ "$#" -gt 0 ]; then
  shift
fi

case "$command_name" in
  tmux)
    exec tmux -L neotui -f "$ROOT_DIR/tmux/tmux.conf" new-session -A -s neotui
    ;;
  zsh)
    exec zsh "$@"
    ;;
  nvim)
    exec nvim "$@"
    ;;
  lf)
    exec lf "$@"
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    usage >&2
    exit 1
    ;;
esac
