#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="${BASH_SOURCE[0]}"

while [ -L "$SCRIPT_PATH" ]; do
  LINK_TARGET="$(readlink "$SCRIPT_PATH")"
  if [[ "$LINK_TARGET" == /* ]]; then
    SCRIPT_PATH="$LINK_TARGET"
  else
    SCRIPT_PATH="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)/$LINK_TARGET"
  fi
done

SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

export NEOTUI_ROOT="$ROOT_DIR"
export XDG_CONFIG_HOME="$ROOT_DIR"
export XDG_DATA_HOME="$ROOT_DIR/.local/data"
export XDG_STATE_HOME="$ROOT_DIR/.local/state"
export XDG_CACHE_HOME="$ROOT_DIR/.local/cache"
export PATH="$ROOT_DIR/.local/bin:$PATH"
export ZDOTDIR="$ROOT_DIR/shell"
export HISTFILE="$XDG_STATE_HOME/zsh/history"
export EDITOR="nvim"
export VISUAL="nvim"
export NVIM_APPNAME="nvim"
shell_path="$(command -v zsh)"
export SHELL="$shell_path"

mkdir -p "$XDG_DATA_HOME" "$XDG_STATE_HOME" "$XDG_CACHE_HOME" "$(dirname "$HISTFILE")"

usage() {
  printf 'Usage: neotui [--debug] [tmux|zsh|nvim|lf] [args...]\n'
}

print_tool_info() {
  local name="$1"
  local version_cmd="$2"

  if ! command -v "$name" >/dev/null 2>&1; then
    printf '  - %-4s: missing\n' "$name"
    return
  fi

  local path
  local version
  path="$(command -v "$name")"
  version="$(eval "$version_cmd" 2>/dev/null | awk 'NR==1 {print; exit}')"
  if [ -z "$version" ]; then
    version="unknown"
  fi
  printf '  - %-4s: %s (%s)\n' "$name" "$path" "$version"
}

print_link_status() {
  local label="$1"
  local path="$2"
  local expected="$3"

  if [ ! -e "$path" ] && [ ! -L "$path" ]; then
    printf '  - %-5s: absent (%s)\n' "$label" "$path"
    return
  fi

  if [ -L "$path" ]; then
    local target
    target="$(readlink "$path")"
    if [ "$target" = "$expected" ]; then
      printf '  - %-5s: linked to NeoTUI (%s -> %s)\n' "$label" "$path" "$target"
    else
      printf '  - %-5s: symlink not NeoTUI (%s -> %s)\n' "$label" "$path" "$target"
    fi
    return
  fi

  printf '  - %-5s: regular file exists (%s)\n' "$label" "$path"
}

debug_report() {
  printf 'NeoTUI debug report\n'
  printf 'root: %s\n' "$ROOT_DIR"
  printf 'command: %s\n' "$command_name"
  printf 'tools:\n'
  print_tool_info tmux "tmux -V"
  print_tool_info zsh "zsh --version"
  print_tool_info nvim "nvim --version"
  print_tool_info lf "lf -version"
  printf 'global-config links:\n'
  print_link_status tmux "$HOME/.tmux.conf" "$ROOT_DIR/tmux/tmux.conf"
  print_link_status zsh "$HOME/.zshrc" "$ROOT_DIR/shell/.zshrc"
  print_link_status nvim "$HOME/.config/nvim/init.lua" "$ROOT_DIR/nvim/init.lua"
  printf 'env:\n'
  printf '  - NEOTUI_ROOT: %s\n' "$NEOTUI_ROOT"
  printf '  - XDG_CONFIG_HOME: %s\n' "$XDG_CONFIG_HOME"
  printf '  - XDG_DATA_HOME: %s\n' "$XDG_DATA_HOME"
  printf '  - XDG_STATE_HOME: %s\n' "$XDG_STATE_HOME"
  printf '  - XDG_CACHE_HOME: %s\n' "$XDG_CACHE_HOME"
  printf '  - ZDOTDIR: %s\n' "$ZDOTDIR"
  printf '  - NVIM_APPNAME: %s\n' "$NVIM_APPNAME"
}

debug_mode=0
while [ "$#" -gt 0 ]; do
  case "$1" in
    --debug)
      debug_mode=1
      shift
      ;;
    --)
      shift
      break
      ;;
    -h|--help|help)
      command_name="help"
      shift
      break
      ;;
    -* )
      usage >&2
      exit 1
      ;;
    *)
      break
      ;;
  esac
done

if [ "${command_name:-}" != "help" ]; then
  command_name="${1:-tmux}"
  if [ "$#" -gt 0 ]; then
    shift
  fi
fi

if [ "$debug_mode" -eq 1 ]; then
  debug_report
  exit 0
fi

case "$command_name" in
  tmux)
    exec tmux -L neotui -f "$ROOT_DIR/tmux/tmux.conf" new-session -A -s neotui
    ;;
  zsh)
    exec zsh "$@"
    ;;
  nvim)
    exec nvim "$@"
    ;;
  lf)
    exec lf "$@"
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    usage >&2
    exit 1
    ;;
esac
