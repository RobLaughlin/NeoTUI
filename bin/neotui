#!/usr/bin/env bash
# ============================================================
# NeoTUI - Launcher
# Starts a tmux session with sidebar layout and full environment
# ============================================================
set -euo pipefail

# ─── Colors ──────────────────────────────────────────────────
BOLD='\033[1m'
DIM='\033[2m'
CYAN='\033[36m'
BLUE='\033[34m'
GREEN='\033[32m'
YELLOW='\033[33m'
MAGENTA='\033[35m'
NC='\033[0m'

# ─── Help ────────────────────────────────────────────────────
show_help() {
    echo -e "${BOLD}NeoTUI${NC} — a modern terminal IDE, out of the box"
    echo ""
    echo -e "${BOLD}USAGE${NC}"
    echo "    neotui [options] [directory]"
    echo ""
    echo -e "${BOLD}OPTIONS${NC}"
    echo "    -h, --help      Show this help message"
    echo ""
    echo -e "${BOLD}ARGUMENTS${NC}"
    echo "    directory        Start in this directory (default: current dir)"
    echo ""
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo -e "${BOLD}${CYAN}TMUX${NC}  ${DIM}prefix = Ctrl+b${NC}"
    echo ""
    echo -e "  ${BOLD}Windows (Tabs)${NC}"
    echo -e "    ${GREEN}prefix, c${NC}        Create new window (with lf sidebar)"
    echo -e "    ${GREEN}prefix, &${NC}        Close current window"
    echo -e "    ${GREEN}prefix, n${NC}        Next window"
    echo -e "    ${GREEN}prefix, p${NC}        Previous window"
    echo -e "    ${GREEN}prefix, 1-9${NC}      Jump to window by number"
    echo -e "    ${GREEN}prefix, ,${NC}        Rename window"
    echo -e "    ${GREEN}prefix, w${NC}        Window picker"
    echo ""
    echo -e "  ${BOLD}Panes${NC}"
    echo -e "    ${GREEN}prefix, |${NC}        Split vertically"
    echo -e "    ${GREEN}prefix, -${NC}        Split horizontally"
    echo -e "    ${GREEN}prefix, x${NC}        Close pane"
    echo -e "    ${GREEN}prefix, h/j/k/l${NC}  Navigate panes"
    echo -e "    ${GREEN}prefix, H/J/K/L${NC}  Resize panes"
    echo -e "    ${GREEN}prefix, z${NC}        Toggle pane zoom"
    echo ""
    echo -e "  ${BOLD}TUI Controls${NC}"
    echo -e "    ${GREEN}prefix, T${NC}        Toggle tab bar"
    echo -e "    ${GREEN}prefix, E${NC}        Toggle file explorer sidebar"
    echo -e "    ${GREEN}prefix, v${NC}        Open Neovim in current dir"
    echo -e "    ${GREEN}prefix, O${NC}        Open opencode (split below)"
    echo -e "    ${GREEN}prefix, r${NC}        Reload tmux config"
    echo ""
    echo -e "  ${BOLD}Copy Mode${NC}  ${DIM}(prefix, [  to enter)${NC}"
    echo -e "    ${GREEN}v${NC}                Begin selection"
    echo -e "    ${GREEN}y${NC}                Copy selection"
    echo -e "    ${GREEN}q / Esc${NC}          Exit copy mode"
    echo ""
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo -e "${BOLD}${CYAN}NEOVIM${NC}  ${DIM}leader = Space${NC}"
    echo ""
    echo -e "  ${BOLD}File Navigation (Telescope)${NC}"
    echo -e "    ${GREEN}Space ff${NC}         Find files"
    echo -e "    ${GREEN}Space fg${NC}         Live grep (search text)"
    echo -e "    ${GREEN}Space fb${NC}         Find buffers"
    echo -e "    ${GREEN}Space fr${NC}         Recent files"
    echo -e "    ${GREEN}Space fs${NC}         Document symbols"
    echo -e "    ${GREEN}Space fd${NC}         Diagnostics"
    echo ""
    echo -e "  ${BOLD}LSP (Code Intelligence)${NC}"
    echo -e "    ${GREEN}gd${NC}               Go to definition"
    echo -e "    ${GREEN}gD${NC}               Go to declaration"
    echo -e "    ${GREEN}gi${NC}               Go to implementation"
    echo -e "    ${GREEN}gr${NC}               Find references"
    echo -e "    ${GREEN}K${NC}                Hover documentation"
    echo -e "    ${GREEN}Space rn${NC}         Rename symbol"
    echo -e "    ${GREEN}Space ca${NC}         Code action"
    echo -e "    ${GREEN}Space f${NC}          Format file"
    echo -e "    ${GREEN}[d / ]d${NC}          Prev / next diagnostic"
    echo ""
    echo -e "  ${BOLD}Buffers & Windows${NC}"
    echo -e "    ${GREEN}Shift+l / h${NC}      Next / prev buffer"
    echo -e "    ${GREEN}Space bd${NC}         Close buffer"
    echo -e "    ${GREEN}Ctrl+h/j/k/l${NC}    Navigate windows"
    echo ""
    echo -e "  ${BOLD}Editing${NC}"
    echo -e "    ${GREEN}Space w${NC}          Save file"
    echo -e "    ${GREEN}Space q${NC}          Quit"
    echo -e "    ${GREEN}Space h${NC}          Clear search highlight"
    echo -e "    ${GREEN}v J / K${NC}          Move selection down / up"
    echo -e "    ${GREEN}Ctrl+d / u${NC}       Half-page jump (centered)"
    echo ""
    echo -e "  ${BOLD}AI Completion (Codeium)${NC}"
    echo -e "    ${GREEN}Tab${NC}              Accept ghost text suggestion"
    echo -e "    ${GREEN}Alt+w${NC}            Accept next word"
    echo -e "    ${GREEN}Alt+l${NC}            Accept next line"
    echo -e "    ${GREEN}Alt+] / [${NC}        Cycle suggestions"
    echo -e "    ${GREEN}Ctrl+Space${NC}       Open LSP completion menu"
    echo -e "    ${GREEN}Ctrl+e${NC}           Dismiss suggestion"
    echo ""
    echo -e "  ${BOLD}Git${NC}"
    echo -e "    ${GREEN}Space gc${NC}         Git commits"
    echo -e "    ${GREEN}Space gs${NC}         Git status"
    echo -e "    ${GREEN}]c / [c${NC}          Next / prev hunk"
    echo -e "    ${GREEN}Space hp${NC}         Preview hunk"
    echo -e "    ${GREEN}Space hs${NC}         Stage hunk"
    echo -e "    ${GREEN}Space hb${NC}         Blame line"
    echo ""
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo -e "${BOLD}${CYAN}ZSH${NC}  ${DIM}vi-mode (beam = insert, block = normal)${NC}"
    echo ""
    echo -e "  ${BOLD}Insert Mode Shortcuts${NC}"
    echo -e "    ${GREEN}Ctrl+a / e${NC}       Beginning / end of line"
    echo -e "    ${GREEN}Ctrl+w${NC}           Delete previous word"
    echo -e "    ${GREEN}Ctrl+u / k${NC}       Delete to start / end"
    echo -e "    ${GREEN}Ctrl+p / n${NC}       Previous / next history"
    echo -e "    ${GREEN}Ctrl+l${NC}           Clear screen"
    echo ""
    echo -e "  ${BOLD}Sync & Search${NC}"
    echo -e "    ${GREEN}sync${NC}             Sync lf sidebar to current directory"
    echo -e "    ${GREEN}Ctrl+r${NC}           Fuzzy history search"
    echo -e "    ${GREEN}Ctrl+t${NC}           Fuzzy file search"
    echo -e "    ${GREEN}Alt+c${NC}            Fuzzy directory jump"
    echo ""
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo -e "${BOLD}${CYAN}LF${NC}  ${DIM}(file explorer sidebar)${NC}"
    echo ""
    echo -e "  ${BOLD}Navigation${NC}"
    echo -e "    ${GREEN}j / k${NC}            Move down / up"
    echo -e "    ${GREEN}h${NC}                Parent directory"
    echo -e "    ${GREEN}l / Enter${NC}        Open file / enter dir"
    echo -e "    ${GREEN}Shift+Enter / O${NC}  Open file in new tab"
    echo -e "    ${GREEN}gg / G${NC}           Top / bottom"
    echo -e "    ${GREEN}.${NC}                Toggle hidden files"
    echo -e "    ${GREEN}zp${NC}               Toggle preview pane"
    echo -e "    ${GREEN}S${NC}                Sync shell to lf's directory"
    echo ""
    echo -e "  ${BOLD}File Operations${NC}"
    echo -e "    ${GREEN}yy${NC}               Copy file"
    echo -e "    ${GREEN}dd${NC}               Trash file"
    echo -e "    ${GREEN}dD${NC}               Delete permanently"
    echo -e "    ${GREEN}pp${NC}               Paste file"
    echo -e "    ${GREEN}r${NC}                Rename"
    echo -e "    ${GREEN}R${NC}                Bulk rename"
    echo -e "    ${GREEN}md${NC}               Create directory"
    echo -e "    ${GREEN}mf${NC}               Create file"
    echo -e "    ${GREEN}yp${NC}               Copy path to clipboard"
    echo ""
    echo -e "  ${BOLD}Quick Dirs${NC}"
    echo -e "    ${GREEN}gh${NC}  ~    ${GREEN}gp${NC}  ~/projects    ${GREEN}gd${NC}  ~/Documents    ${GREEN}g/${NC}  /"
    echo ""
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo -e "${BOLD}${CYAN}ALIASES${NC}"
    echo ""
    echo -e "    ${GREEN}v${NC}    nvim          ${GREEN}ll${NC}   eza -la --icons --git"
    echo -e "    ${GREEN}la${NC}   eza -a         ${GREEN}lt${NC}   eza --tree --level=3"
    echo -e "    ${GREEN}gs${NC}   git status     ${GREEN}ga${NC}   git add"
    echo -e "    ${GREEN}gc${NC}   git commit     ${GREEN}gd${NC}   git diff"
    echo -e "    ${GREEN}gl${NC}   git log        ${GREEN}py${NC}   python3"
    echo -e "    ${GREEN}..${NC}   cd ..          ${GREEN}...${NC}  cd ../.."
    echo ""
    echo -e "${BOLD}${CYAN}USEFUL COMMANDS${NC}"
    echo ""
    echo -e "    ${GREEN}glow${NC} FILE.md       Render markdown in terminal"
    echo -e "    ${GREEN}mdpreview${NC} FILE.md  GitHub-style preview in browser"
    echo -e "    ${GREEN}bat${NC}  FILE          View file with syntax highlighting"
    echo -e "    ${GREEN}fd${NC}   PATTERN       Find files by name"
    echo -e "    ${GREEN}rg${NC}   PATTERN       Search file contents"
    echo ""
}

# ─── Parse arguments ─────────────────────────────────────────
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
esac

# ─── Configuration ───────────────────────────────────────────
SESSION_NAME="neotui"
STATE_DIR="$HOME/.local/share/neotui"
WIDTH_FILE="$STATE_DIR/sidebar-width"
DEFAULT_WIDTH=30
START_DIR="${1:-.}"

# Resolve to absolute path
START_DIR="$(cd "$START_DIR" 2>/dev/null && pwd || echo "$PWD")"

mkdir -p "$STATE_DIR"

# Read persisted sidebar width
load_width() {
    if [[ -f "$WIDTH_FILE" ]]; then
        local saved
        saved=$(<"$WIDTH_FILE")
        if [[ "$saved" =~ ^[0-9]+$ ]] && (( saved >= 10 && saved <= 200 )); then
            echo "$saved"
            return
        fi
    fi
    echo "$DEFAULT_WIDTH"
}

# ─── Pre-flight checks ──────────────────────────────────────
if ! command -v tmux &>/dev/null; then
    echo "Error: tmux is not installed" >&2
    exit 1
fi

if ! command -v lf &>/dev/null; then
    echo "Warning: lf is not installed (sidebar will not work)" >&2
    echo "Run install.sh to install dependencies" >&2
fi

# ─── Attach to existing session if it exists ─────────────────
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Attaching to existing session '$SESSION_NAME'..."
    exec tmux attach-session -t "$SESSION_NAME"
fi

# ─── Create new session ─────────────────────────────────────
tmux new-session -d -s "$SESSION_NAME" -c "$START_DIR"

# Set environment variables in the tmux session
tmux set-environment -t "$SESSION_NAME" NEOTUI_DIR "${NEOTUI_DIR:-$(dirname "$(dirname "$(readlink -f "$0")")")}"

# Rename the first window
tmux rename-window -t "$SESSION_NAME:1" 'main'

# Create sidebar pane with lf on the left (using saved width)
if command -v lf &>/dev/null; then
    SIDEBAR_WIDTH=$(load_width)
    tmux split-window -t "$SESSION_NAME:1" -hb -l "$SIDEBAR_WIDTH" -c "$START_DIR" 'lf'
    # Focus back to the right (main) pane
    tmux select-pane -t "$SESSION_NAME:1" -R
fi

# Source the tmux config if not already loaded
if [ -f "$HOME/.tmux.conf" ]; then
    tmux source-file "$HOME/.tmux.conf" 2>/dev/null || true
fi

# ─── Attach ──────────────────────────────────────────────────
exec tmux attach-session -t "$SESSION_NAME"
